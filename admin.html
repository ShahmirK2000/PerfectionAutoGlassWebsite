<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin - Perfection Auto Glass</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  </head>

  <body class="bg-light">
    <div class="container py-5" style="max-width: 720px;">
      <h1 class="h3 mb-4">Admin Panel</h1>

      <!-- Login -->
      <div id="loginCard" class="card shadow-sm mb-4">
        <div class="card-body">
          <h2 class="h5 mb-3">Sign in</h2>
          <div class="mb-3">
            <label class="form-label">Admin password</label>
            <input id="password" type="password" class="form-control" autocomplete="current-password" />
          </div>
          <button id="loginBtn" class="btn btn-primary">Login</button>
          <div id="loginMsg" class="text-danger mt-3" style="display:none;"></div>
        </div>
      </div>

      <!-- Invoice form -->
      <div id="invoiceCard" class="card shadow-sm" style="display:none;">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <h2 class="h5 mb-3">Invoice details</h2>
            <button id="logoutBtn" class="btn btn-outline-secondary btn-sm">Logout</button>
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Customer name</label>
              <input id="customerName" class="form-control" placeholder="John Smith" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Customer email</label>
              <input id="customerEmail" type="email" class="form-control" placeholder="john@email.com" />
            </div>

            <div class="col-md-4">
              <label class="form-label">Amount</label>
              <input id="amount" type="number" step="0.01" min="0" class="form-control" placeholder="299.99" />
            </div>
            <div class="col-md-4">
              <label class="form-label">Currency</label>
              <select id="currency" class="form-select">
                <option value="USD" selected>USD</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Item label</label>
              <input id="itemName" class="form-control" placeholder="Auto glass service" value="Auto glass service" />
            </div>

            <div class="col-12">
              <label class="form-label">Notes</label>
              <textarea id="notes" class="form-control" rows="3" placeholder="Windshield replacement quote for 2018 Camry..."></textarea>
            </div>

            <div class="col-12">
              <button id="createBtn" class="btn btn-success">Generate Pay Link</button>
              <span id="status" class="ms-3 text-muted"></span>
            </div>
          </div>

          <hr class="my-4" />

          <div id="result" style="display:none;">
            <div class="mb-2"><strong>Invoice link:</strong></div>
            <div class="input-group mb-3">
              <input id="invoiceUrl" class="form-control" readonly />
              <button id="copyLinkBtn" class="btn btn-outline-primary">Copy</button>
            </div>

            <div class="mb-2"><strong>Text message:</strong></div>
            <textarea id="smsText" class="form-control" rows="3" readonly></textarea>
            <button id="copySmsBtn" class="btn btn-outline-primary mt-2">Copy message</button>
          </div>

          <div id="error" class="alert alert-danger mt-3" style="display:none;"></div>
        </div>
      </div>
    </div>

    <script>
      // Worker URL
      const API_BASE = "https://perfectionworker-adminpanel.perfectautoglassmn.workers.dev";

      const loginCard = document.getElementById("loginCard");
      const invoiceCard = document.getElementById("invoiceCard");
      const loginMsg = document.getElementById("loginMsg");
      const statusEl = document.getElementById("status");
      const errorEl = document.getElementById("error");
      const resultEl = document.getElementById("result");

      let token = sessionStorage.getItem("pag_admin_token") || "";

      function showError(msg) {
        errorEl.style.display = "block";
        errorEl.textContent = msg;
      }
      function clearError() {
        errorEl.style.display = "none";
        errorEl.textContent = "";
      }
      function setStatus(msg) {
        statusEl.textContent = msg || "";
      }

      async function api(path, body) {
        const res = await fetch(API_BASE + path, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...(token ? { "Authorization": "Bearer " + token } : {})
          },
          body: JSON.stringify(body || {})
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          throw new Error(data?.error || ("Request failed: " + res.status));
        }
        return data;
      }

      async function tryShowAuthed() {
        if (!token) return;
        try {
          await api("/me", {});
          loginCard.style.display = "none";
          invoiceCard.style.display = "block";
        } catch {
          token = "";
          sessionStorage.removeItem("pag_admin_token");
        }
      }

      document.getElementById("loginBtn").addEventListener("click", async () => {
        clearError();
        loginMsg.style.display = "none";
        setStatus("Logging in...");
        try {
          const password = document.getElementById("password").value;
          const data = await api("/login", { password });
          token = data.token;
          sessionStorage.setItem("pag_admin_token", token);
          setStatus("");
          loginCard.style.display = "none";
          invoiceCard.style.display = "block";
        } catch (e) {
          setStatus("");
          loginMsg.style.display = "block";
          loginMsg.textContent = e.message || "Login failed";
        }
      });

      document.getElementById("logoutBtn").addEventListener("click", () => {
        token = "";
        sessionStorage.removeItem("pag_admin_token");
        invoiceCard.style.display = "none";
        loginCard.style.display = "block";
      });

      document.getElementById("createBtn").addEventListener("click", async () => {
        clearError();
        resultEl.style.display = "none";
        setStatus("Creating invoice...");

        try {
          const payload = {
            customerName: document.getElementById("customerName").value.trim(),
            customerEmail: document.getElementById("customerEmail").value.trim(),
            amount: document.getElementById("amount").value,
            currency: document.getElementById("currency").value,
            itemName: document.getElementById("itemName").value.trim(),
            notes: document.getElementById("notes").value.trim()
          };

          const data = await api("/create-invoice", payload);

          document.getElementById("invoiceUrl").value = data.invoiceUrl;

          const sms = `Perfection Auto Glass invoice: ${data.invoiceUrl}\n\nYou can pay securely online. If you have any questions, reply to this message.`;
          document.getElementById("smsText").value = sms;

          resultEl.style.display = "block";
          setStatus("Done.");
        } catch (e) {
          setStatus("");
          showError(e.message || "Failed to create invoice");
        }
      });

      document.getElementById("copyLinkBtn").addEventListener("click", async () => {
        await navigator.clipboard.writeText(document.getElementById("invoiceUrl").value);
      });
      document.getElementById("copySmsBtn").addEventListener("click", async () => {
        await navigator.clipboard.writeText(document.getElementById("smsText").value);
      });

      tryShowAuthed();
    </script>
  </body>
</html>
